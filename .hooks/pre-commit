#!/usr/bin/env bash
#
# Pre-commit validation orchestrator for claude-persona
#
# Runs all pre-commit checks in sequence.
# Exit codes: 0 = pass, 1 = fail
# Only runs on main/master branches.

set -e

# Only run on main/master branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || git branch --show-current 2>/dev/null || echo "main")
if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
    echo "ğŸ­ Skipping pre-commit checks on branch: $CURRENT_BRANCH (checks only run on main/master)"
    exit 0
fi

# Path resolution (works from .git/hooks/ or .hooks/)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    CHECKS_DIR="$SCRIPT_DIR/pre-commit.d"
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    CHECKS_DIR="$SCRIPT_DIR/pre-commit.d"
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

cd "$PROJECT_ROOT"

ERROR=0

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_header() {
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}  $1${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

run_check() {
    local script="$1"
    local name="$2"

    if [ ! -f "$script" ]; then
        echo -e "${RED}  âœ— Check script not found: $script${NC}"
        ERROR=1
        return
    fi

    echo ""
    echo -e "  Running: $name"

    if [ -x "$script" ]; then
        if "$script"; then
            echo -e "${GREEN}  âœ“ $name passed${NC}"
        else
            echo -e "${RED}  âœ— $name failed${NC}"
            ERROR=1
        fi
    else
        if bash "$script"; then
            echo -e "${GREEN}  âœ“ $name passed${NC}"
        else
            echo -e "${RED}  âœ— $name failed${NC}"
            ERROR=1
        fi
    fi
}

print_header "Pre-commit Checks (claude-persona)"

# Run checks
run_check "$CHECKS_DIR/check-tests.sh" "Bun Tests"
run_check "$CHECKS_DIR/check-typescript.sh" "TypeScript Compilation"

echo ""
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ $ERROR -eq 1 ]; then
    echo -e "${RED}  âœ— Commit blocked: One or more checks failed${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}  âœ“ All pre-commit checks passed${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
exit 0
